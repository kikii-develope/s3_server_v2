name: Docker Build and Push

on:
  push:
    tags:
      - '*'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-northeast-2
      AWS_IAM_USER_KEY: ${{ secrets.AWS_IAM_USER_KEY }}
      AWS_IAM_USER_SECRET: ${{ secrets.AWS_IAM_USER_SECRET }}
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check if tag is from dev-cicd
        id: check_branch
        run: |
          git fetch origin dev-cicd
          if git merge-base --is-ancestor origin/dev-cicd ${{ github.sha }}; then
            echo "tag_from_dev_cicd=true" >> $GITHUB_ENV
          else
            echo "❌ This tag is not from dev-cicd. Exiting."
            echo "tag_from_dev_cicd=false" >> $GITHUB_ENV
          fi

      - name: Exit if not from dev-cicd
        if: env.tag_from_dev_cicd != 'true'
        run: exit 0

      - name: Extract tag name
        id: extract_tag
        shell: bash
        run: echo "IMAGE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Echo image tag
        run: |
          echo "Tag: $IMAGE_TAG"
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER_NAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: "kikidockerhub/file-server:${{ env.IMAGE_TAG }}"


      - name: Install yq
        run: sudo apt-get install -y yq

      #Git 커밋 및 푸쉬
      - name: Update image tag in Helm values.yaml
        run: |
          yq -y -i '.image.tag = "${{ env.IMAGE_TAG }}"' Helm/values.yaml

      - name: Commit and Push updated values.yaml
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Helm/values.yaml
          git commit -m "Update image tag to $IMAGE_TAG"
          git push origin HEAD:dev-cicd 